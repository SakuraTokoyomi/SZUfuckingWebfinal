<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>舞萌DX - Q&A</title>
    <link rel="stylesheet" href="../css/nav.css">
    <link rel="stylesheet" href="../css/qaDetail.css">

</head>
<body>
<canvas class="canvas-wrap" id="triangle-lost-in-space" resize="true"></canvas>
<nav class="homenav">
    <div class="navtitle"><img src="../image/maimai2023.png">
        <div class="search">
            <div class="container">
                <i class="fa-brands fa-windows item"></i>
                <div class="search-box">
                    <input type="text" class="search-btn" id="search" placeholder="搜索">
                </div>
                <i class="fa-solid fa-magnifying-glass item" onclick="search()"></i>
            </div>
        </div>
    </div>
    <a href="home.html">HOME</a>
    <a href="about.html">ABOUT</a>
    <a href="QA.html">Q&A</a>
    <a href="login.html">LOGIN</a>
    <div class="navanim QA"></div>
    <div class="none" onclick="jumpToUserInfo()"><img src="../image/login.png" class="login" id="navAvater"></div>
</nav>
<script src="../node_modules/jquery/dist/jquery.js"></script>
<script src="../node_modules/editor.md/lib/marked.min.js"></script>
<script src="../node_modules/editor.md/lib/prettify.min.js"></script>
<script src="../node_modules/editor.md/lib/raphael.min.js"></script>
<script src="../node_modules/editor.md/lib/underscore.min.js"></script>
<script src="../node_modules/editor.md/lib/sequence-diagram.min.js"></script>
<script src="../node_modules/editor.md/lib/flowchart.min.js"></script>
<script src="../node_modules/editor.md/lib/jquery.flowchart.min.js"></script>
<script src="../node_modules/editor.md/editormd.js"></script>
<!--QA细节-->
<main>
    <!--占位-->
    <div class="QADetailBlcok"></div>
    <div>
        <div class="content">
            <!-- 主要内容部分 -->
            <div class="co-right" id="next-one">
                <div class="content-li li2">

                    <h1>
                        <span>问题</span>
                        <div class="borderbotm"></div>
                        <span>01</span>
                    </h1>
                    <div class="underQ">
                        <p id="current-time"></p>
                        <button onclick="back()">&lt;返回</button>
                    </div>

                    <div class="li2-box carbox">
                        <!--问题标题部分-->
                        <div id="questionTitle"></div>
                        <br>
                        <!--问题主要内容部分-->
                        <div id="questionContent">
                        </div>
                        <!--问题图片部分-->
                        <div id="questionImages"></div>
                        <!--问题时间部分-->
                        <div class="question-footer">
                            <div id="questionTime"></div>

                            <div class="rightDiv" onclick="rightDivOnClick()">
                                <svg t="1704195227032" class="moreIcon" viewBox="0 0 1024 1024" version="1.1"
                                     xmlns="http://www.w3.org/2000/svg" p-id="4579" width="40" height="40">
                                    <path d="M895.362889 128.853858H135.997131c-41.735766 0-75.936241 22.935003-75.936242 71.33372 0 48.39671 34.200476 71.331714 75.936242 71.331714h759.365758c41.735766 0 75.936241-22.935003 75.936241-71.331714-0.103691-48.513111-34.199807-71.333721-75.936241-71.33372z m0 319.491875H135.997131c-41.735766 0-75.936241 22.935003-75.936242 71.33372s34.200476 71.333721 75.936242 71.333721h759.365758c41.735766 0 75.936241-22.935003 75.936241-71.333721-0.103691-48.51378-34.199807-71.333721-75.936241-71.33372z m0 311.626113H135.997131c-41.735766 0-75.936241 22.933665-75.936242 71.331713 0 48.392696 34.200476 71.333721 75.936242 71.333721h759.365758c41.735766 0 75.936241-22.941024 75.936241-71.333721-0.103691-48.519132-34.199807-71.331714-75.936241-71.331713z m0 0"
                                          p-id="4580"></path>
                                    <div class="findNine" id="moreButtonBox">
                                    </div>
                                </svg>


                            </div>

                        </div>
                    </div>
                </div>

                <div class="content-li li3" id="answer-box">
                    <h1>
                        <span>回答</span>
                        <div class="borderbotm"></div>
                        <span>02</span>
                    </h1>

                </div>
                <div class="borderbotm"></div>


            </div>
        </div>

    </div>
</main>
<script>
    const serverHost = "http://3zureus.vm.szu.moe:8080";
    const urlParams = new URLSearchParams(window.location.search);
    const QAID = urlParams.get('QAID');

    const xhr = new XMLHttpRequest();
    xhr.responseType = 'json';
    xhr.onreadystatechange = function () {
        var testEditormdView;
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                // 如果状态码为 200 表示请求成功

                let jsonResponse = xhr.response;
                // 设置问题标题
                document.getElementById("questionTitle").innerHTML = jsonResponse.Data.Title;
                // 设置问题内容

                var markdown = jsonResponse.Data.Content;
                testEditormdView = editormd.markdownToHTML("questionContent", {
                    markdown: markdown,//+ "\r\n" + $("#append-test").text(),
                    htmlDecode: "style,script,iframe",  // you can filter tags decode
                    tocm: true,    // Using [TOCM]
                    emoji: true,
                    taskList: true,
                    tex: true,  // 默认不解析
                    flowChart: true,  // 默认不解析
                    sequenceDiagram: true,  // 默认不解析
                });
                // 设置问题图片
                let questionImages = jsonResponse.Data.ImgUrls;
                let questionImagesHTML = "";
                for (let i = 0; i < questionImages.length; i++) {
                    questionImagesHTML += `<img src="${serverHost}${questionImages[i]}" class="imgAdd" alt="questionImage">`;
                }
                document.getElementById("questionImages").innerHTML = questionImagesHTML;
                // 设置问题时间,从Unix时间戳转换为正常时间
                let questionTime = new Date(jsonResponse.Data.CreatedAt * 1000);
                document.getElementById("questionTime").innerHTML = "发布时间<br>" + questionTime.toLocaleString();

                let buttonDiv = document.getElementById("moreButtonBox");
                let userID = parseInt(getCookie("userid"));
                console.log(typeof userID);
                console.log(typeof jsonResponse.Data.AuthorId);
                if (userID === jsonResponse.Data.AuthorId) {
                    let deleteButton = document.createElement("button");
                    deleteButton.innerHTML = "删除";
                    deleteButton.onclick = function () {
                        let deleteXHR = new XMLHttpRequest();
                        deleteXHR.responseType = 'json';
                        deleteXHR.onreadystatechange = function () {
                            if (deleteXHR.readyState === 4) {
                                if (deleteXHR.status === 200) {
                                    // 如果状态码为 200 表示请求成功
                                    alert("删除成功！");
                                    window.location.href = "QA.html";
                                } else if (deleteXHR.status === 400) {
                                    alert(deleteXHR.response);
                                } else {
                                    // 如果状态码不为 200，请求可能失败或者出现错误
                                    console.error('Request failed with status:', deleteXHR.status);
                                    console.log(deleteXHR.response);
                                }
                            }
                        }
                        deleteXHR.open('GET', serverHost + `/webapi/QA/delete-question?QAID=${QAID}&AuthorID=${userID}`, true);
                        deleteXHR.setRequestHeader("Token", getCookie("Token"));
                        deleteXHR.send();
                    }
                    buttonDiv.append(deleteButton);
                    let updateButton = document.createElement("button");
                    updateButton.innerHTML = "修改";
                    updateButton.onclick = function () {
                        window.location.href = `questionEditor.html?QAID=${QAID}`;
                    }
                    buttonDiv.append(updateButton);
                }
                let answerButton = document.createElement("button");
                answerButton.innerHTML = "回答";
                answerButton.onclick = function () {
                    window.location.href = `answerEditor.html?QAID=${QAID}`;
                }
                buttonDiv.append(answerButton);

                // 设置回答内容, 在id为answer-box的div中后插入添加回答内容，如果没有回答则添加等待添加回答的提示
                let answerHTML = "";
                let answers = jsonResponse.Data.Answers;
                let answersBox = document.getElementById("answer-box");
                if (answers.length === 0) {
                    let noAnswer = document.createElement("div");
                    let noAnswerWords = document.createElement("p");
                    noAnswerWords.className = "noAnswerWords";
                    noAnswerWords.innerHTML = "暂无回答，快来添加回答吧！";
                    noAnswer.append(noAnswerWords);
                    answersBox.append(noAnswer);
                } else {
                    for (let i = 0; i < answers.length; i++) {
                        let answer = document.createElement("div");
                        let answerContent = document.createElement("div");
                        let answerImages = document.createElement("div");
                        let answerTime = document.createElement("div");
                        let answerContentWords = document.createElement("p");
                        answerContentWords.innerHTML = answers[i].Content;
                        answerContent.append(answerContentWords);
                        answer.append(answerContent);
                        let imgUrls = answers[i].ImgUrls;
                        for (let j = 0; j < imgUrls.length; j++) {
                            let answerImage = document.createElement("img");
                            answerImage.src = serverHost + imgUrls[j];
                            answerImages.append(answerImage);
                        }
                        answer.append(answerImages);
                        let answerTimeDate = new Date(answers[i].CreatedAt * 1000);
                        answerTime.innerHTML = answerTimeDate.toLocaleString();
                        answer.append(answerTime);
                        answersBox.append(answer);
                    }
                    answersBox.insertAdjacentHTML("afterend", answerHTML);
                }

            } else if (xhr.status === 400) {
                alert(xhr.responseText);
            } else {
                // 如果状态码不为 200，请求可能失败或者出现错误
                console.error('Request failed with status:', xhr.status);
                console.log(xhr.responseText);
            }
            // console.log("onreadystatechange 1st if triggered!");
        }
    }
    xhr.open('GET', serverHost + `/webapi/QA/get-detail?QAID=${QAID}`, true);
    // xhr.open('GET', `addRentalServer.php`, true);
    xhr.send();
</script>
<script>
    document.getElementById('search').addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // 阻止表单默认提交行为
            var searchTerm = encodeURIComponent(this.value); // 获取并编码输入框的值
            window.location.href = 'search.html?Keyword=' + searchTerm; // 跳转到 search.html 并附加搜索词
        }
    });

</script>
<script>
    function updateTime() {
        const now = new Date();
        const options = {
            year: 'numeric',
            month: 'numeric',
            day: 'numeric',
            hour: 'numeric',
            minute: 'numeric',
            second: 'numeric'
        };
        const currentDateTime = now.toLocaleString(undefined, options);
        document.getElementById('current-time').textContent = `${currentDateTime}`;
    }

    updateTime();

    // Refresh time every second
    setInterval(updateTime, 1000);
</script>
<script src="https://kit.fontawesome.com/f23451c27c.js" crossorigin="anonymous"></script>
<script src="../js/global.js"></script>
<script type="text/javascript" src="../js/paper-full.min.js"></script>
<script src="../js/detail_canvas.js"></script>
<script>
    var isrightDivClick = false;
    function rightDivOnClick(){
        console.log("rightDivOnClick triggered!")
        var findNine = document.getElementsByClassName("findNine")[0];
        if(isrightDivClick){
            isrightDivClick = false;
            findNine.style.height="0px";
        }else{
            isrightDivClick = true;
            // findNine.style.display = "block";
            // findNine.style.animation = "findNine 1s ease-in-out";
            findNine.style.height="125px";
        }
    }
    function back(){
        window.history.back();
    }
</script>

</body>
</html>